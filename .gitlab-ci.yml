# SPDX-License-Identifier: MIT
stages:
  - validate
  - sync_internal
  - sync_external

variables:
  GIT_DEPTH: 0   # ensure full history, not shallow
  TF_ROOT: "${CI_PROJECT_DIR}"

# Shared cleanup steps
.before_cleanup: &before_cleanup
  - apk update && apk add --no-cache git
  - git clone --depth=1 $CI_REPOSITORY_URL repo-clean
  - cd repo-clean
  - git fetch --unshallow || true
  # Strip sensitive files before syncing
  - rm -rf .env terraform/ansible-vars/* *.tfvars

# Internal sync (Gitea)
sync_to_gitea:
  stage: sync_internal
  script:
    - *before_cleanup
    - git remote add gitea https://oauth2:${GITEA_TOKEN}@git.crumpton.org/bear/terraform-proxmox-infrastructure.git
    - git commit -am "Cleaned sync" || true
    - git push gitea main --force
    - git push gitea $CI_COMMIT_TAG
  # rules:
  #   - if: '$CI_COMMIT_TAG =~ /^v\.\d+\.\d+\.\d+$/'

# External sync (GitHub) â€” manual approval required
sync_to_github:
  stage: sync_external
  script:
    - *before_cleanup
    - git remote add github https://oauth2:${GITHUB_TOKEN}@github.com/davidcrumpton/terraform-proxmox-infrastructure.git
    - git commit -am "Cleaned sync" || true
    - git push github main --force
    - git push github $CI_COMMIT_TAG
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\.\d+\.\d+\.\d+$/'
  when: manual   # requires manual approval in GitLab UI
