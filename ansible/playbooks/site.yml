---
# site.yml
# Master playbook to configure all LXCs provisioned by Terraform.

- name: "Base configuration for all LXCs"
  hosts: all
  become: yes
  gather_facts: yes

  vars_files:
    # Each host has its own YAML vars file auto-generated by Terraform
    - "../../terraform/ansible-vars/{{ inventory_hostname }}.ansible_vars.yaml"

  roles:
    - common            # baseline configuration (users, updates, etc.)
  #  - cups            # baseline configuration (users, updates, etc.)
  #  - networking        # optional role for static/dhcp config tuning

  tasks:
    - name: Display basic host info (debug sanity check)
      ansible.builtin.debug:
        msg:
          - "Hostname: {{ hostname }}"
          - "Node: {{ node }}"
          - "VMID: {{ vmid }}"
          - "Storage: {{ storage }}"
          - "Networks: {{ networks | to_nice_yaml }}"
          - "Tags: {{ tags | to_nice_yaml }}"

#------------------------------------------------------------------------------
# Tag-based role inclusion â€“ dynamically applies roles based on Terraform tags
#------------------------------------------------------------------------------

- name: "Role-based configuration"
  hosts: all
  become: yes
  gather_facts: no

  vars_files:
    # Each host has its own YAML vars file auto-generated by Terraform
    - "../../terraform/ansible-vars/{{ inventory_hostname }}.ansible_vars.yaml"

  tasks:


    - name: Include roles dynamically based on Terraform tags
      ansible.builtin.include_role:
        name: "{{ item | trim }}"
      loop: "{{ tags.split(',') | map('trim') | list }}"
      when: tags is defined and tags | length > 0
      ignore_errors: yes