---
# site.yml
# Master playbook to configure all LXCs provisioned by Terraform.

- name: "Base configuration for all LXCs"
  hosts: all
  become: yes
  gather_facts: yes

  # vars_files:
  #   # Each host has its own YAML vars file auto-generated by Terraform
  #   - "../../terraform/ansible-vars/{{ inventory_hostname }}.ansible_vars.yaml"

  roles:
    - common            # baseline configuration (users, updates, etc.)
  #  - cups            # baseline configuration (users, updates, etc.)
  #  - networking        # optional role for static/dhcp config tuning

  tasks:
    - name: Include host-specifc vars
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../../terraform/ansible-vars/{{ inventory_hostname }}.ansible_vars.yaml"

    - name: Display basic host info (debug sanity check)
      ansible.builtin.debug:
        msg:
          - "Hostname: {{ hostname }}"
          - "Node: {{ node }}"
          - "VMID: {{ vmid }}"
          - "Storage: {{ storage }}"
          - "Networks: {{ networks | to_nice_yaml }}"
          - "Tags: {{ tags | to_nice_yaml }}"

    - name: Include roles dynamically based on tags {{ inventory_hostname }}
      ansible.builtin.include_role:
        name: "{{ item }}"
      loop: "{{ tags.split(',') | map('trim') | list }}"
      when: lookup('first_found', [
              playbook_dir + '/roles/' + item,
              playbook_dir + '/../roles/' + item
            ], errors='ignore') is not none


#------------------------------------------------------------------------------
# Tag-based role inclusion â€“ dynamically applies roles based on Terraform tags
#------------------------------------------------------------------------------

# - name: "Role-based configuration"
#   hosts: all
#   become: yes
#   gather_facts: no

  # vars_files:
  #   # Each host has its own YAML vars file auto-generated by Terraform
  #   - ../../terraform/ansible-vars/{{ hostname }}.ansible_vars.yaml"

  # tasks:
  #   - name: Include host-specifc vars
  #     ansible.builtin.include_vars:
  #       file: "{{ playbook_dir }}/../../terraform/ansible-vars/{{ inventory_hostname }}.ansible_vars.yaml"

    # - debug:
    #     msg: "{{ tags }}"

    # - name: Include roles dynamically based on Terraform tags {{ inventory_hostname }}
    #   ansible.builtin.include_role:
    #     name: "{{ item | trim }}"
    #   loop: "{{ tags.split(',') | map('trim') | list }}"
    #   when: tags is defined and tags | length > 0
    #   ignore_errors: yes