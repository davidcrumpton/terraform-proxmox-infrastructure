#!/usr/bin/env sh
# SPDX-License-Identifier: MIT
 
BRANCH="main"
TAG="$1"
 
# Check if a tag was provided
if [ -z "$TAG" ]; then
    echo "Error: No tag specified." >&2
    echo "Usage: $0 vX.Y.Z" >&2
    exit 1
fi
 
# Check if the tag matches the vX.Y.Z pattern
# The pattern v[0-9]*.[0-9]*.[0-9]* matches tags like v1.0.0, v12.3.45, etc.
case "$TAG" in
    v[0-9]*.[0-9]*.[0-9]*)
        echo "Valid tag provided: $TAG"
        
        # 1. Checkout the specified branch
        git checkout "$BRANCH"
        
        # Check if checkout was successful
        if [ $? -ne 0 ]; then
            echo "Error: Failed to checkout branch $BRANCH" >&2
            exit 1
        fi
        
        # 2. Create the annotated tag
        # Use $TAG for the message to clearly show what was tagged
        git tag -a "$TAG" -m "New Release $TAG ($(date))"
        
        # Check if tagging was successful
        if [ $? -ne 0 ]; then
            echo "Error: Failed to create tag $TAG" >&2
            exit 1
        fi
 
        # 3. Push the new tag to the remote
        echo "Pushing tag $TAG to origin..."
        git push origin "$TAG"
        
        # Final status check
        if [ $? -eq 0 ]; then
            echo "Success: Tag $TAG created and pushed."
        else
            echo "Error: Failed to push tag $TAG" >&2
            exit 1
        fi
        ;;
    *)
        # Executed if the tag does not match the pattern
        echo "Error: Invalid tag format '$1'." >&2
        echo "Tag must match the pattern vX.Y.Z (e.g., v1.0.0)." >&2
        exit 1
        ;;
esac